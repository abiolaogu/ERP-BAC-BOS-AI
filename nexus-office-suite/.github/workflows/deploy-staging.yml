name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  KUBE_NAMESPACE: nexus-staging

jobs:
  deploy:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.nexus.example.com

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push images
        run: |
          for service in auth writer sheets slides drive meet gateway hub; do
            docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/$service:staging services/$service
            docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/$service:staging
          done

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --name nexus-staging --region us-east-1

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f kubernetes/staging/ -n ${{ env.KUBE_NAMESPACE }}
          kubectl set image deployment/* *=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/*:staging -n ${{ env.KUBE_NAMESPACE }}
          kubectl rollout status deployment -n ${{ env.KUBE_NAMESPACE }} --timeout=10m

      - name: Run database migrations
        run: |
          kubectl run migration-${{ github.run_number }} \
            --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth:staging \
            --restart=Never \
            --command -- npm run migrate \
            -n ${{ env.KUBE_NAMESPACE }}
          kubectl wait --for=condition=complete job/migration-${{ github.run_number }} --timeout=5m -n ${{ env.KUBE_NAMESPACE }}

      - name: Run smoke tests
        run: |
          cd tests/e2e
          npm ci
          BASE_URL=https://staging.nexus.example.com npm run test:smoke

      - name: Notify deployment status
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Staging deployment ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,took

      - name: Create deployment record
        run: |
          echo "Deployed to staging at $(date)" >> deployment-log.txt
          echo "Commit: ${{ github.sha }}" >> deployment-log.txt
          echo "Services: auth, writer, sheets, slides, drive, meet, gateway, hub" >> deployment-log.txt

      - name: Upload deployment log
        uses: actions/upload-artifact@v3
        with:
          name: staging-deployment-log
          path: deployment-log.txt
          retention-days: 90
